<html><head>    <title>Travel and Entertainment Search</title>    <style>        table {            width: 90%;            margin-left: auto;            margin-right: auto;            border-collapse: collapse;        }        td, th, tr {            border: 2px solid #D1D0D1;        }        a.address:hover , a.place:hover{            color: #837F83;            cursor: pointer;        }        a.travelMode {            font-size: 14px;        }        span#travelModes span {            text-align: center;            width: 18%;            display: block;            background: #F0F0F0;            padding: 7px;        }        span#travelModes span:hover {            cursor: pointer;            background: #DCDCDC;        }        div#placeInfoContainer{            width: 555px;            display: block;            margin-left: auto;            text-align: center;            margin-right: auto;        }        div#placeName{            margin-bottom: 40px;        }        div#photosContainer{            width: 555px;            display: block;            margin-left: auto;            text-align: center;            margin-right: auto;        }    </style></head><body><?php$searchResult = NULL;$placeInfoJson = NULL;$lat = 0;$long = 0;$fillSearchBox = "false";$arrContextOptions = array(    "ssl" => array(        "verify_peer" => false,        "verify_peer_name" => false,    ),);$customLocationForm = "";$categoryForm = "";$distanceForm = 10;$keywordForm = "";$customLocationSelected = "false";$geoCodeKey = "AIzaSyDhm9vuozFuJ-YqMgX1UTkOk0QND4hkL3E";$placesKey = "AIzaSyB9syddmfdLtCW6th5dedBvvi-Ka_zmYmw";$mapsJSKey = "AIzaSyBiliCbyStvqvQAXDyJNzjgmMiNmuiCrVI";if (isset($_POST["searchPlace"]) && $_POST["searchPlace"] != "") {    $fillSearchBox = "true";    if (!($_POST["source"] == "here")) {        $customLocationSelected = "true";        $customLocationForm = $_POST["customLocationInput"];    }    $keywordForm = $_POST["keyword"];    $distanceForm = $_POST["distance"];    $categoryForm = $_POST["category"];    $placeId = $_POST["searchPlace"];    $placeInfoUrl = "https://maps.googleapis.com/maps/api/place/details/json?placeid=" . $placeId . "&key=" . $placesKey;    $placeInfoJson = file_get_contents($placeInfoUrl, false, stream_context_create($arrContextOptions));    $placeInfo = json_decode($placeInfoJson,true)["result"];    if(array_key_exists("photos",$placeInfo)){        for($i =0;$i<count($placeInfo["photos"]);++$i){            $photoReference = $placeInfo["photos"][(string)$i]["photo_reference"];            $photoReferenceUrl = "https://maps.googleapis.com/maps/api/place/photo?maxwidth=750&photoreference=".$photoReference."&key=".$placesKey;            file_put_contents("image".$i.".png",file_get_contents($photoReferenceUrl,false,stream_context_create($arrContextOptions)));        }    }}if (isset($_POST["btnSubmit"])) {    //Set latitude and longitude    $fillSearchBox = "true";    if (!($_POST["source"] == "here")) {        //If custom location is given, then get location using geoCode API        $customLocationSelected = "true";        $customLocationForm = $_POST["customLocationInput"];        $customLocation = str_replace(" ","+",$customLocationForm);        $geoCodingInfoUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=" . $customLocation . ",&key=" . $geoCodeKey;        $geoLocation = json_decode(file_get_contents($geoCodingInfoUrl, false, stream_context_create($arrContextOptions)), true)["results"]["0"]["geometry"]["location"];        $lat = $geoLocation["lat"];        $long = $geoLocation["lng"];    } else {        $geoLocation = json_decode(file_get_contents("http://ip-api.com/json"), true);        $lat = $geoLocation["lat"];        $long = $geoLocation["lon"];    }    //Get nearby places    $keywordForm = $_POST["keyword"];    $distanceForm = $_POST["distance"];    $categoryForm = $_POST["category"];    $keyword = str_replace(" ","+",$_POST["keyword"]);    $radius = $_POST["distance"] * 1609.34;    $nearByPlacesUrl = "https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=" . $lat . "," . $long . "&radius=" . $radius . "&keyword=" . $keyword . "&key=" . $placesKey;    if ($_POST["category"] != "default") {        $nearByPlacesUrl = $nearByPlacesUrl . "&type=" . str_replace(" ","_",$_POST["category"]);    }    $searchResult = file_get_contents($nearByPlacesUrl, false, stream_context_create($arrContextOptions));}?><script type="application/javascript">    var map, directionsService, directionsDisplay, selectedDestination, selectedOrigin;    window.onload = function () {        var xmlHttpRequest = new XMLHttpRequest();        xmlHttpRequest.open('GET', "http://ip-api.com/json", true);        xmlHttpRequest.onload = function (e) {            if (xmlHttpRequest.readyState === 4) {                if (xmlHttpRequest.status === 404) {                    alert("Error getting the geoLocationInfo");                    return;                }                if (xmlHttpRequest.status === 200) {                    var geoLocationInfo = JSON.parse(xmlHttpRequest.responseText);                    document.getElementById("Search").disabled = false;                }            }        };        xmlHttpRequest.send();        createSearchResultTable();        createPlaceResult();        fillSearchBox();    };    function fillSearchBox() {        if(<?php echo $fillSearchBox;?>){            document.getElementById("keyword").value = "<?php echo $keywordForm; ?>";            document.getElementById("category").value = "<?php echo $categoryForm; ?>";            document.getElementById("distance").value = <?php echo $distanceForm; ?>;            if(<?php echo $customLocationSelected;?>){                document.getElementById("customLocationInput").value = "<?php echo $customLocationForm; ?>";                document.getElementById("customLocation").checked = true;                showInputBox(true);            }        }    }    function validate() {        var distanceElement = document.getElementById("distance");        if(distanceElement.value == ""){            distanceElement.value = 10;        };        var keyword = document.getElementById("keyword").value;        if (keyword.trim() == "") {            return false;        }        var customLocation = document.getElementById("customLocation");        if (customLocation.checked) {            if (customLocation.value.trim() == "") {                return false;            }        }        return true;    }    function showInputBox(show) {        var input = document.getElementById("customLocationInput");        input.disabled = !show;    }    function initMap() {        directionsService = new google.maps.DirectionsService();        directionsDisplay = new google.maps.DirectionsRenderer();        selectedOrigin = {};        selectedOrigin.lat = <?php echo $lat; ?>;        selectedOrigin.lng = <?php echo $long; ?>;        map = new google.maps.Map(document.getElementById("map"), {            zoom: 15,            center: selectedOrigin        });        directionsDisplay.setMap(map);    }    function calcRoute(travelMode) {        var request = {            origin: new google.maps.LatLng(selectedOrigin, true),            destination: new google.maps.LatLng(selectedDestination, true),            travelMode: travelMode        };        directionsService.route(request, function (response, status) {            if (status == 'OK') {                directionsDisplay.setDirections(response);            }        });    }    function getOffset(el) {        el = el.getBoundingClientRect();        return {            left: el.left + window.scrollX,            top: el.top + window.scrollY        }    }    function showMap(elmnt) {        initMap();        selectedDestination = {};        selectedDestination.lat = parseFloat(elmnt.getAttribute("lat"));        selectedDestination.lng = parseFloat(elmnt.getAttribute("lng"));        new google.maps.Marker({            position: selectedDestination,            map: map        });        var mapContainer = document.getElementById("mapContainer");        if (mapContainer.style.display === "block") {            mapContainer.style.display = "none";        } else {            var position = getOffset(elmnt);            mapContainer.style.left = position.left;            mapContainer.style.top = position.top + 20;            mapContainer.style.display = "block";        }        mapContainer.style.height = 300 + "px";        mapContainer.style.width = 400 + "px";    }    function showPlaceDetails(elmnt) {        document.form.searchPlace.value = elmnt.getAttribute("placeId");        document.form.submit();    }    function createPlaceResult(){        var empty = null;        var placeInfo = <?php            if ($placeInfoJson == NULL)                echo "empty";            else                echo $placeInfoJson;            ?>;        if (placeInfo !== null) {            placeInfo = placeInfo.result;            var placeInfoContainer = document.getElementById("placeInfoContainer");            document.getElementById("placeName").innerHTML = "<b>" + placeInfo.name + "</b>";            //Render reviews            var noOfReviews = 0;            if(placeInfo.hasOwnProperty("reviews")){                noOfReviews = Math.min(5,placeInfo.reviews.length);            }            var htmlContent = "<table>";            if(noOfReviews === 0){                htmlContent+="<tr style='text-align: center'><td><b>No Reviews found</b></td></tr>";            }else{                for(i =0;i<noOfReviews;++i){                    var review = placeInfo.reviews[i];                    htmlContent+="<tr style='text-align: center'><td><img style='width: 25px' src='"+review.profile_photo_url+"'><b> "+review.author_name+"</b></td></tr>";                    htmlContent+="<tr><td>"+review.text+"</td></tr>"                }            }            htmlContent += "</table>";            document.getElementById("reviewTableContainer").innerHTML = htmlContent;            placeInfoContainer.style.display = "block";            //Render photos            var noOfPhotos = 0;            if(placeInfo.hasOwnProperty("photos")){                noOfPhotos = Math.min(5,placeInfo.photos.length);            }            var htmlContent = "<table>";            if(noOfPhotos === 0){                htmlContent+="<tr style='text-align: center'><td><b>No Photos found</b></td></tr>";            }else{                for(i =0;i<noOfPhotos;++i) {                    htmlContent += "<tr><td><a href='image"+i+".png' target='_blank'><img style='width: 500px;margin: 8px' src='image"+i+".png'></a></td></tr>"                }            }            htmlContent += "</table>";            document.getElementById("photosContainer").innerHTML = htmlContent;        }    }    function createSearchResultTable() {        var empty = null;        var searchResult = <?php            if ($searchResult == NULL)                echo "empty";            else                echo $searchResult;            ?>;        if (searchResult !== null) {            var htmlContent = "<table>";            if (searchResult.results.length === 0) {                htmlContent+="<tr style='text-align:center;background-color:#EFEFEF'><td><b>No Records has been found</b></td></tr>";            } else {                htmlContent += "<colgroup><col width='10%'><col width='50%' ><col width='40%'></colgroup>";                htmlContent += "<tr><th>Category</th><th>Name</th><th>Address</th></tr>";                searchResult = searchResult.results;                for (i = 0; i < searchResult.length; ++i) {                    htmlContent += "<tr>";                    htmlContent += "<td style='text-align:center'><img style='height: 40px; width: 50px' src ='" + searchResult[i].icon + "' ></td>";                    htmlContent += "<td style='padding-left:5px'><a class='place' placeId='" + searchResult[i].place_id + "' onClick='showPlaceDetails(this);'>" + searchResult[i].name + "</a></td>";                    htmlContent += "<td style='padding-left:5px'><a class='address' lat=" + searchResult[i].geometry.location.lat + " lng=" + searchResult[i].geometry.location.lng + " onclick='showMap(this)'>" + searchResult[i].vicinity + "</a></td>";                    htmlContent += "</tr>";                }            }            htmlContent += "</table>";            document.getElementById("tableContainer").innerHTML = htmlContent;        }    }    function togglePhoto(){        var showPhotos = document.getElementById("showPhotos");        var hidePhotos = document.getElementById("hidePhotos");        var hideReviews = document.getElementById("hideReviews");        if(hideReviews.style.display !== "none"){            toggleReviews();        }        if(showPhotos.style.display === "none"){            hidePhotos.style.display = "none";            showPhotos.style.display = "block";        }else{            showPhotos.style.display = "none";            hidePhotos.style.display = "block";        }    }    function toggleReviews(){        var hidePhotos = document.getElementById("hidePhotos");        var showReviews = document.getElementById("showReviews");        var hideReviews = document.getElementById("hideReviews");        if(hidePhotos.style.display !== "none"){            togglePhoto();        }        if(showReviews.style.display === "none"){            hideReviews.style.display = "none";            showReviews.style.display = "block";        }else{            showReviews.style.display = "none";            hideReviews.style.display = "block";        }    }    function clearAll() {        showInputBox(false);        document.getElementById("tableContainer").innerHTML = "";        document.getElementById("reviewTableContainer").innerHTML = "";        document.getElementById("photosContainer").innerHTML = "";        document.getElementById("placeInfoContainer").style.display = "none";    }</script><?phpif (isset($_POST["btnSubmit"])) {    echo "<script async defer src=\"https://maps.googleapis.com/maps/api/js?key=" . $mapsJSKey . "&callback=initMap\"></script>";}?><div id="formContainer"     style="width: 555px;height: 202px;border: 2px solid #D1D0D1;text-align: center;background-color: #F1F1F1;padding: 10px;margin-left: auto;margin-right: auto;">    <h1 style="margin: 0;"><i>Travel and Entertainment Search</i></h1>    <hr style="border: none;height: 2px;background-color: #D1D0D1;">    <form name="form" method="POST" action="" style="text-align: left" onsubmit="return validate();">        <div style="margin:10px 0;"><b>Keyword</b> <input type="text" id="keyword" name="keyword" autocomplete="off" required><br></div>        <div style="margin: 10px 0;"><b>Category</b>            <select id="category" name="category">                <option value="default">default</option>                <option value="cafe">cafe</option>                <option value="bakery">bakery</option>                <option value="restaurant">restaurant</option>                <option value="beauty salon">beauty salon</option>                <option value="casino">casino</option>                <option value="movie theater">movie theater</option>                <option value="lodging">lodging</option>                <option value="airport">airport</option>                <option value="train station">train station</option>                <option value="subway station">subway station</option>                <option value="bus station">bus station</option>            </select><br></div>        <b>Distance (miles)</b> <input id="distance" type="text" name="distance" placeholder="10" autocomplete="off">        <b>from</b>        <input type="radio" id="currentLocation" onclick="showInputBox(false);" name="source" value="here" checked>        <label for="currentLocation">here</label><br>        <div style="position:relative; left: 320px;">            <input onclick="showInputBox(true);" type="radio" id="customLocation" name="source">            <input placeholder="location" name="customLocationInput" id="customLocationInput" type="text" autocomplete="off" disabled required>        </div>        <br>        <div style="position: relative;left: 50px;"><input style="margin: 0 10px;" id="Search" type="submit"                                                           name="btnSubmit" value="Search" disabled>            <input type="reset" name="reset" value="Clear" onclick="clearAll()"></div>        <input type="hidden" name="searchPlace">    </form></div><div id="tableContainer" style="margin: 25px 0;"></div><div id= "placeInfoContainer" style="display: none">    <div id="placeName"></div>    <div id="showReviews" style="margin: 10px 0;">        <div>click to show reviews</div>        <img style="width: 40px" src="http://cs-server.usc.edu:45678/hw/hw6/images/arrow_down.png" onclick="toggleReviews()">    </div>    <div id="hideReviews" style="margin: 10px 0; display: none">        <div>click to hide reviews</div>        <img style="width: 40px" src="http://cs-server.usc.edu:45678/hw/hw6/images/arrow_up.png" onclick="toggleReviews()">        <div id="reviewTableContainer"></div>    </div>    <div id="showPhotos" style="margin: 10px 0;">        <div>click to show photos</div>        <img style="width: 40px" src="http://cs-server.usc.edu:45678/hw/hw6/images/arrow_down.png" onclick="togglePhoto();">    </div>    <div id="hidePhotos" style="margin: 10px 0;display: none">        <div>click to hide photos</div>        <img style="width: 40px" src="http://cs-server.usc.edu:45678/hw/hw6/images/arrow_up.png" onclick="togglePhoto();">        <div id="photosContainer"></div>    </div></div><div id="mapContainer" style="position: absolute;display: none">    <div id="map" style="height: 300px;width: 400px"></div>    <span id="travelModes" style="position: relative; bottom: 300px;">        <span><a class="travelMode" onclick="calcRoute('WALKING');">Walk there</a></span>        <span><a class="travelMode" onclick="calcRoute('BICYCLING');">Bike there</a></span>        <span><a class="travelMode" onclick="calcRoute('DRIVING');">Drive there</a></span>    </span></div></body></html>